<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pulpa TV — Slideshow</title>

    <style>
      /* 1920x1080 stage that also scales to fit the viewport */
      html, body {
        height: 100%;
        margin: 0;
        background: #000;
      }

      .stage {
        width: 1920px;
        height: 1080px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(var(--scale, 1));
        transform-origin: center;
        overflow: hidden;
        background: #000;
      }

      .slide {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 600ms ease;
      }

      .slide.is-active {
        opacity: 1;
      }

      .hint {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        color: rgba(255, 255, 255, 0.75);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.6);
      }
    </style>
  </head>

  <body>
    <div class="stage" id="stage">
      <img class="slide is-active" id="slideA" alt="Slideshow image A" />
      <img class="slide" id="slideB" alt="Slideshow image B" />
      <div class="hint" id="hint"></div>
    </div>

    <script>
      // -----------------------------
      // CONFIG
      // -----------------------------
      // The slideshow can be configured in two ways:
      // 1) Default here (SLIDES_FALLBACK)
      // 2) A generated HTML can set `window.SLIDES = [...]` before this script runs
      //    where each item is: { src: string, durationMs: number }
      const SLIDES_FALLBACK = [
        { src: 'img.png', durationMs: 10000 },
        { src: 'img3.gif', durationMs: 10000 }
      ];

      const SLIDES = Array.isArray(window.SLIDES) && window.SLIDES.length
        ? window.SLIDES
        : SLIDES_FALLBACK;

      // -----------------------------
      // STAGE SCALE (keeps 1920x1080 proportion)
      // -----------------------------
      (function setupScale() {
        const stage = document.getElementById('stage');

        function applyScale() {
          const scaleX = window.innerWidth / 1920;
          const scaleY = window.innerHeight / 1080;
          const scale = Math.min(scaleX, scaleY);
          stage.style.setProperty('--scale', String(scale));
        }

        window.addEventListener('resize', applyScale, { passive: true });
        applyScale();
      })();

      // -----------------------------
      // "Synchronous" loading behavior:
      // - We DO NOT start the slideshow until ALL images are loaded.
      // - We preload sequentially (one after another), so we only advance
      //   after each one has fully loaded.
      // -----------------------------
      function preloadSlidesSequential(slides) {
        const loaded = [];

        return slides.reduce((promiseChain, slide) => {
          return promiseChain.then(() => {
            return new Promise((resolve, reject) => {
              const img = new Image();
              img.decoding = 'sync';
              img.loading = 'eager';
              img.onload = () => {
                loaded.push(slide);
                resolve();
              };
              img.onerror = () => reject(new Error('No se pudo cargar: ' + slide.src));
              img.src = slide.src;
            });
          });
        }, Promise.resolve()).then(() => loaded);
      }

      function startSlideshow(slides) {
        const slideA = document.getElementById('slideA');
        const slideB = document.getElementById('slideB');
        const hint = document.getElementById('hint');

        if (!slides.length) {
          hint.textContent = 'No hay slides configurados.';
          return;
        }

        // Normalize durations and src
        const normalized = slides
          .filter(s => s && typeof s.src === 'string' && s.src.trim().length)
          .map(s => ({
            src: s.src,
            durationMs: Number.isFinite(Number(s.durationMs)) && Number(s.durationMs) > 0
              ? Number(s.durationMs)
              : 5000
          }));

        if (!normalized.length) {
          hint.textContent = 'No hay slides válidos (src/durationMs).';
          return;
        }

        // Initialize
        let currentIndex = 0;
        let showingA = true;
        let timerId = null;

        slideA.src = normalized[0].src;
        slideA.classList.add('is-active');
        slideB.classList.remove('is-active');
        hint.textContent = '';

        function scheduleNext() {
          const current = normalized[currentIndex];
          const wait = current.durationMs;

          timerId = window.setTimeout(() => {
            // advance index
            currentIndex = (currentIndex + 1) % normalized.length;
            const nextSlide = normalized[currentIndex];

            const incoming = showingA ? slideB : slideA;
            const outgoing = showingA ? slideA : slideB;

            incoming.src = nextSlide.src;

            requestAnimationFrame(() => {
              incoming.classList.add('is-active');
              outgoing.classList.remove('is-active');
              showingA = !showingA;
              scheduleNext();
            });
          }, wait);
        }

        // Safety: clear on unload
        window.addEventListener('beforeunload', () => {
          if (timerId) window.clearTimeout(timerId);
        });

        scheduleNext();
      }

      // This script runs synchronously as the HTML is parsed (it’s inline and at the end of body).
      // We only *begin* the slideshow after all images finish loading.
      (function boot() {
        const hint = document.getElementById('hint');

        if (!Array.isArray(SLIDES) || SLIDES.length === 0) {
          hint.textContent = 'Configura SLIDES (o SLIDES_FALLBACK) para apuntar a tus imágenes.';
          return;
        }

        hint.textContent = 'Cargando imágenes…';

        preloadSlidesSequential(SLIDES)
          .then((loadedSlides) => {
            startSlideshow(loadedSlides);
          })
          .catch((err) => {
            hint.textContent = String(err && err.message ? err.message : err);
            // Optional: log for debugging
            console.error(err);
          });
      })();
    </script>
  </body>
</html>